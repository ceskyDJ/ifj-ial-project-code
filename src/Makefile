# Makefile
#
# IFJ and IAL project (IFJ21 compiler)
# Team: 128 (variant II)
#
# Author: Martin Havlík (xhavli56)
# Author: Michal Šmahel (xsmahe01)

BINARY_NAME=ifj21_compiler
DOC_NAME=main

CC=gcc
CFLAGS=-std=c11 -g -pedantic -Wall -Wextra

# `make` only compiles main binary
all: build

# Template for compiling modules
# This is used for rules generated by `dep` rule
# $< ... first prerequisite
%.o: %.c
	$(CC) $(CFLAGS) -c $<

# Link modules into final binary
build: *.o
	$(CC) $(CFLAGS) *.o -o ../bin/$(BINARY_NAME)

#######################################
# Generate module dependencies
dep:
	$(CC) -MM *.c >dep.list

-include dep.list
#######################################

# Compile documentation (from its Git repository)
doc:
	git clone git@github.com:ceskyDJ/ifj-ial-project-docs.git
	cd ifj-ial-project-docs; pdflatex $(DOC_NAME).tex
	cd ifj-ial-project-docs; bibtex $(DOC_NAME).aux
	cd ifj-ial-project-docs; pdflatex $(DOC_NAME).tex
	cd ifj-ial-project-docs; pdflatex $(DOC_NAME).tex
	mv ifj-ial-project-docs/$(DOC_NAME).pdf ../tmp/dokumentace.pdf
	rm -rf ifj-ial-project-docs

# Create final archive
archive: make_tmp doc copy_src copy_special copy_makefile
	cd ../tmp; tar -czf ../xsmahe01.tar.gz *
	rm -rf ../tmp

# Copy source files into tmp folder (for creating archive)
copy_src:
	cp -r *.c *.h ../tmp/

# Copy special files (required by assignment) into tmp folder
# File `rozsireni` hasn't to exists, so `cd` should end with exit code 1 in this case.
# To solve this problem there is || true (in case of `cd` error generate exit code 0)
copy_special:
	cp ../rozdeleni ../rozsireni ../tmp/ || true

# Copy Makefile into tmp folder with path conversion (development paths to production ones)
copy_makefile:
	cp Makefile ../tmp/
	sed -i 's/..\/bin/./' ../tmp/Makefile

# Create tmp folder where the final project structure will be prepared
make_tmp:
	mkdir ../tmp

# Define virtual files and cleaning stuff
.PHONY: clean doc all archive copy_src copy_special make_tmp build dep copy_makefile
clean:
	rm -f *.o *.c~ *.h~

cleanall: clean
	rm -f dep.list ../xsmahe01.tar.gz
